# v2.0 Routing Architecture - Test Plan

**Purpose:** Validate that agent routing correctly maps task tags to the appropriate specialists in the v2.0 architecture.

**Test Date:** 2025-10-24
**Architecture Version:** 2.0.0
**Configuration File:** `src/main/resources/configuration/agent-mapping-v2.yaml`

---

## Test Strategy

### Routing Decision Points

1. **recommend_agent(taskId)** - Primary routing mechanism
2. **Tag analysis** - Maps task tags to agent + Skills
3. **Complexity assessment** - Simple vs complex scenarios
4. **Skill loading** - Correct Skills loaded for domain

### Success Criteria

- ✅ Correct agent recommended based on task tags
- ✅ Correct Skills identified for Implementation Specialist
- ✅ No routing conflicts or ambiguity
- ✅ Fallback behavior works when no tags match
- ✅ Multi-domain tasks load multiple Skills

---

## Test Scenarios

### Category 1: Implementation Specialist (Haiku) Routing

**Expected Behavior:** Tasks with domain tags route to Implementation Specialist with appropriate Skill loaded.

#### Test 1.1: Backend Implementation
```yaml
Test Case: Backend API task routing
Task Tags: [backend, api, rest]
Expected Agent: Implementation Specialist (Haiku)
Expected Skill: backend-implementation
Validation:
  - recommend_agent returns "Implementation Specialist"
  - nextAction.skills_loaded includes "backend-implementation"
  - sectionTags includes backend-relevant tags
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 1.2: Frontend Implementation
```yaml
Test Case: Frontend UI task routing
Task Tags: [frontend, ui, react, component]
Expected Agent: Implementation Specialist (Haiku)
Expected Skill: frontend-implementation
Validation:
  - recommend_agent returns "Implementation Specialist"
  - nextAction.skills_loaded includes "frontend-implementation"
  - sectionTags appropriate for frontend work
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 1.3: Database Implementation
```yaml
Test Case: Database migration task routing
Task Tags: [database, migration, schema, flyway]
Expected Agent: Implementation Specialist (Haiku)
Expected Skill: database-implementation
Validation:
  - recommend_agent returns "Implementation Specialist"
  - nextAction.skills_loaded includes "database-implementation"
  - sectionTags include schema/migration tags
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 1.4: Testing Implementation
```yaml
Test Case: Test automation task routing
Task Tags: [testing, test, qa, unit-test]
Expected Agent: Implementation Specialist (Haiku)
Expected Skill: testing-implementation
Validation:
  - recommend_agent returns "Implementation Specialist"
  - nextAction.skills_loaded includes "testing-implementation"
  - sectionTags include testing-relevant tags
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 1.5: Documentation Implementation
```yaml
Test Case: Documentation task routing
Task Tags: [documentation, docs, api-docs]
Expected Agent: Implementation Specialist (Haiku)
Expected Skill: documentation-implementation
Validation:
  - recommend_agent returns "Implementation Specialist"
  - nextAction.skills_loaded includes "documentation-implementation"
  - sectionTags appropriate for documentation
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 1.6: Multi-Domain Task (Backend + Database)
```yaml
Test Case: Task spanning multiple domains
Task Tags: [backend, database, api]
Expected Agent: Implementation Specialist (Haiku)
Expected Skills: [backend-implementation, database-implementation]
Validation:
  - recommend_agent returns "Implementation Specialist"
  - nextAction.skills_loaded includes BOTH Skills
  - Agent can handle multi-domain work
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

---

### Category 2: Senior Engineer (Sonnet) Routing

**Expected Behavior:** Tasks with bug/error/blocker/complex tags route to Senior Engineer.

#### Test 2.1: Bug Investigation
```yaml
Test Case: Bug fix task routing
Task Tags: [bug, bugfix, error]
Expected Agent: Senior Engineer (Sonnet)
Expected Skill: N/A (no Skills for Senior Engineer)
Validation:
  - recommend_agent returns "Senior Engineer"
  - nextAction.subagent_type is "Senior Engineer"
  - No Skills loaded (Senior Engineer doesn't use Skills)
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 2.2: Blocker Resolution
```yaml
Test Case: Blocker task routing
Task Tags: [blocker, blocked, investigation]
Expected Agent: Senior Engineer (Sonnet)
Expected Skill: N/A
Validation:
  - recommend_agent returns "Senior Engineer"
  - Reason mentions blocker/debugging
  - Appropriate for complex problem-solving
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 2.3: Complex Refactoring
```yaml
Test Case: Complex refactoring task routing
Task Tags: [complex, refactor, architecture]
Expected Agent: Senior Engineer (Sonnet)
Expected Skill: N/A
Validation:
  - recommend_agent returns "Senior Engineer"
  - Reason mentions complexity
  - Sonnet model appropriate for reasoning
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 2.4: Performance Optimization
```yaml
Test Case: Performance optimization routing
Task Tags: [performance, optimization, profiling]
Expected Agent: Senior Engineer (Sonnet)
Expected Skill: N/A
Validation:
  - recommend_agent returns "Senior Engineer"
  - Appropriate for complex analysis
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

---

### Category 3: Feature Architect (Opus) Routing

**Expected Behavior:** Complex feature creation routes to Feature Architect.

#### Test 3.1: Feature Creation from PRD
```yaml
Test Case: PRD-based feature creation
Input: Multi-paragraph PRD with requirements
Expected Agent: Feature Architect (Opus)
Expected Skill: N/A (Feature Architect doesn't use Skills)
Validation:
  - Feature Orchestration Skill recommends Feature Architect
  - Complexity assessment marks as "complex"
  - Opus model selected for reasoning
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 3.2: Multi-Component Feature
```yaml
Test Case: Feature with multiple integrations
Input: Feature requiring 5+ components, multiple domains
Expected Agent: Feature Architect (Opus)
Expected Skill: N/A
Validation:
  - Complexity score high
  - Feature Architect recommended
  - Templates discovered and applied
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 3.3: Simple Feature (Should NOT route to Feature Architect)
```yaml
Test Case: Simple feature creation (< 200 chars, clear scope)
Input: "Create user profile page"
Expected Agent: N/A (direct creation via Feature Orchestration Skill)
Expected Skill: N/A
Validation:
  - Feature Orchestration Skill creates directly
  - Does NOT launch Feature Architect
  - Saves tokens and time
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

---

### Category 4: Planning Specialist (Sonnet) Routing

**Expected Behavior:** Task breakdown and planning routes to Planning Specialist.

#### Test 4.1: Task Breakdown Request
```yaml
Test Case: Feature needs task breakdown
Input: Feature created, needs tasks
Expected Agent: Planning Specialist (Sonnet)
Expected Skill: N/A (Planning Specialist doesn't use Skills)
Validation:
  - Feature Orchestration Skill recommends Planning Specialist
  - Feature has 5+ expected tasks OR multiple domains
  - Sonnet model for reasoning about breakdown
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 4.2: Domain-Isolated Task Creation
```yaml
Test Case: Planning Specialist creates domain-isolated tasks
Input: Feature with backend, frontend, database, testing needs
Expected Agent: Planning Specialist (Sonnet)
Expected Output:
  - Separate task for each domain
  - Task 1: Database (database-implementation Skill)
  - Task 2: Backend (backend-implementation Skill)
  - Task 3: Frontend (frontend-implementation Skill)
  - Task 4: Testing (testing-implementation Skill)
Validation:
  - One task = one domain (no cross-domain tasks)
  - Tasks tagged correctly for routing
  - Dependencies mapped (Database → Backend → Tests)
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

---

### Category 5: Edge Cases & Fallback Behavior

#### Test 5.1: No Matching Tags
```yaml
Test Case: Task with no recognizable tags
Task Tags: [random, unrecognized-tag]
Expected Agent: Implementation Specialist (Haiku) (fallback)
Expected Skill: N/A (no specific Skill)
Validation:
  - recommend_agent returns fallback recommendation
  - Reason explains no specific match found
  - Defaults to Implementation Specialist or asks user
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 5.2: Conflicting Complexity Signals
```yaml
Test Case: Task has both "simple" and "complex" indicators
Task Tags: [backend, complex]
Expected Agent: Senior Engineer (Sonnet) (complex takes precedence)
Expected Skill: N/A
Validation:
  - Complex tag prioritized over domain tag
  - Senior Engineer recommended for better reasoning
  - Explanation clear about why Senior Engineer chosen
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

#### Test 5.3: Empty Task Description
```yaml
Test Case: Task with minimal information
Task Title: "Fix issue"
Task Description: ""
Task Tags: []
Expected Behavior: Ask user for clarification OR default to Implementation Specialist
Validation:
  - System handles gracefully
  - No routing errors
  - User receives helpful guidance
Status: [ ] Pass  [ ] Fail  [ ] N/A
Notes:
```

---

## Test Execution Plan

### Phase 1: Setup (Pre-Test)
1. ✅ Verify v2.0 architecture committed
2. ✅ Verify agent-mapping-v2.yaml in place
3. ✅ Verify all new agents and Skills created
4. ⬜ Run `setup_claude_orchestration` to install agents/skills
5. ⬜ Verify MCP server running with latest changes

### Phase 2: Manual Testing (Task Creation)
**For each test scenario:**
1. Create test task with specified tags
2. Call `recommend_agent(taskId)`
3. Record actual output
4. Compare against expected output
5. Mark test Pass/Fail
6. Document any deviations

### Phase 3: Integration Testing (End-to-End)
**Test complete workflows:**
1. Feature creation → Planning Specialist → Task execution
2. Bug report → Senior Engineer → Fix implementation
3. Multi-domain feature → Domain-isolated tasks → Parallel execution
4. Simple feature → Direct creation (no specialists)

### Phase 4: Performance Testing
**Measure routing efficiency:**
1. Time to recommend agent (should be < 500ms)
2. Token usage for routing (should be < 200 tokens)
3. Accuracy rate (target: 95%+ correct routing)

### Phase 5: Documentation Review
**Validate documentation accuracy:**
1. agent-mapping-v2.yaml matches actual behavior
2. CLAUDE.md reflects v2.0 architecture
3. Output-styles reference correct agents
4. Skills documentation accurate

---

## Test Results Template

### Summary Statistics
- **Total Tests:** 20
- **Passed:** _____
- **Failed:** _____
- **N/A:** _____
- **Pass Rate:** _____%

### Critical Issues Found
1.
2.
3.

### Non-Critical Issues Found
1.
2.
3.

### Recommendations
1.
2.
3.

---

## Test Data Creation Scripts

### Script 1: Create Test Tasks

```javascript
// Create test tasks for Implementation Specialist routing

// Backend test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Implement user authentication API",
  description: "Create REST API endpoints for user login, logout, and token refresh",
  tags: "backend,api,rest,authentication",
  priority: "high",
  complexity: 6
})

// Frontend test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Create user profile component",
  description: "Build React component for displaying and editing user profile information",
  tags: "frontend,ui,react,component",
  priority: "medium",
  complexity: 5
})

// Database test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Add user_sessions table migration",
  description: "Create Flyway migration for user session tracking",
  tags: "database,migration,schema,flyway",
  priority: "high",
  complexity: 4
})

// Testing test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Write integration tests for auth flow",
  description: "Create comprehensive integration tests for authentication endpoints",
  tags: "testing,test,integration-test,qa",
  priority: "high",
  complexity: 6
})

// Documentation test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Document authentication API",
  description: "Create API reference documentation for authentication endpoints",
  tags: "documentation,docs,api-docs",
  priority: "medium",
  complexity: 3
})

// Multi-domain test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Implement user repository with database integration",
  description: "Create UserRepository service with database queries and business logic",
  tags: "backend,database,repository,service",
  priority: "high",
  complexity: 7
})
```

### Script 2: Create Test Tasks for Senior Engineer

```javascript
// Bug test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Fix NullPointerException in UserService",
  description: "Users report crashes when logging in. Stack trace shows NPE in UserService.authenticate()",
  tags: "bug,bugfix,error,backend",
  priority: "high",
  complexity: 6
})

// Blocker test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Investigate performance bottleneck in query execution",
  description: "Database queries taking 5+ seconds. Blocking feature release.",
  tags: "blocker,investigation,performance,database",
  priority: "high",
  complexity: 8
})

// Complex refactoring test task
manage_container({
  operation: "create",
  containerType: "task",
  title: "Refactor authentication layer architecture",
  description: "Current auth implementation is tightly coupled. Needs architectural redesign.",
  tags: "complex,refactor,architecture,backend",
  priority: "medium",
  complexity: 9
})
```

### Script 3: Test recommend_agent

```javascript
// After creating test tasks, test routing:

// Get all test tasks
const tasks = query_container({
  operation: "search",
  containerType: "task",
  tags: "backend,frontend,database,testing,documentation,bug,blocker,complex"
})

// For each task, test recommend_agent
for (const task of tasks) {
  const recommendation = recommend_agent(taskId: task.id)

  console.log(`Task: ${task.title}`)
  console.log(`Tags: ${task.tags}`)
  console.log(`Recommended: ${recommendation.agent}`)
  console.log(`Reason: ${recommendation.reason}`)
  console.log(`Skills: ${recommendation.nextAction?.skills_loaded || "N/A"}`)
  console.log("---")
}
```

---

## Validation Checklist

### Routing Configuration
- ⬜ agent-mapping-v2.yaml exists
- ⬜ All domain tags mapped (backend, frontend, database, testing, documentation)
- ⬜ Bug/error/blocker tags mapped to Senior Engineer
- ⬜ Feature-creation tag mapped to Feature Architect
- ⬜ Planning tag mapped to Planning Specialist
- ⬜ Skill routing configured correctly
- ⬜ Priority configuration clear

### Agent Definitions
- ⬜ implementation-specialist.md exists and complete
- ⬜ senior-engineer.md exists and complete
- ⬜ feature-architect.md exists (unchanged)
- ⬜ planning-specialist.md exists (unchanged)
- ⬜ Old specialists deprecated with notices

### Skills
- ⬜ backend-implementation/SKILL.md exists
- ⬜ frontend-implementation/SKILL.md exists
- ⬜ database-implementation/SKILL.md exists
- ⬜ testing-implementation/SKILL.md exists
- ⬜ documentation-implementation/SKILL.md exists
- ⬜ All Skills under 500 lines
- ⬜ Skills follow progressive disclosure pattern

### Documentation
- ⬜ escalation-workflow.md exists
- ⬜ CLAUDE.md updated with v2.0 architecture
- ⬜ Output-styles updated
- ⬜ Task orchestration skill updated
- ⬜ Dependency analysis skill updated

---

## Notes & Observations

### Testing Environment
- MCP Server Version: _____
- Claude Code Version: _____
- Test Date: _____
- Tester: _____

### Known Issues Before Testing
1.
2.
3.

### Issues Discovered During Testing
1.
2.
3.

### Proposed Fixes
1.
2.
3.

---

## Sign-Off

**Test Completed By:** _____________________
**Date:** _____________________
**Overall Assessment:** [ ] Ready for Production  [ ] Needs Fixes  [ ] Major Issues
**Recommended Actions:** _____________________
